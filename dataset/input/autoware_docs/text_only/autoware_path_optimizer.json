{
  "title": "Path optimizer",
  "sections": [
    {
      "section-id": 0,
      "title": "Purpose",
      "sentences": [
        {
          "sentence-id": 0,
          "text": "This package generates a trajectory that is kinematically-feasible to drive and collision-free based on the input path, drivable area."
        },
        {
          "sentence-id": 1,
          "text": "Only position and orientation of trajectory are updated in this module, and velocity is just taken over from the one in the input path."
        }
      ]
    },
    {
      "section-id": 1,
      "title": "Feature",
      "sentences": [
        {
          "sentence-id": 0,
          "text": "This package is able to"
        },
        {
          "sentence-id": 1,
          "text": "1.make the trajectory inside the drivable area as much as possible"
        },
        {
          "sentence-id": 2,
          "text": "NOTE: Static obstacles to avoid can be removed from the drivable area."
        },
        {
          "sentence-id": 3,
          "text": "2.insert stop point before the planned footprint will be outside the drivable area"
        },
        {
          "sentence-id": 4,
          "text": "Note that the velocity is just taken over from the input path."
        }
      ]
    },
    {
      "section-id": 2,
      "title": "Flowchart : createPlannerData",
      "sentences": [
        {
          "sentence-id": 0,
          "text": "The following data for planning is created."
        }
      ]
    },
    {
      "section-id": 3,
      "title": "Flowchart : check replan",
      "sentences": [
        {
          "sentence-id": 0,
          "text": "When one of the following conditions are met, trajectory optimization will be executed."
        },
        {
          "sentence-id": 1,
          "text": "Otherwise, previously optimized trajectory is used with updating the velocity from the latest input path."
        },
        {
          "sentence-id": 2,
          "text": "max_path_shape_around_ego_lat_dist"
        },
        {
          "sentence-id": 3,
          "text": "1.Ego moves longer than replan.max_ego_moving_dist in one cycle. (default: 3.0 [m])"
        },
        {
          "sentence-id": 4,
          "text": "This is for when the ego pose is set again in the simulation."
        },
        {
          "sentence-id": 5,
          "text": "2.Trajectory's end, which is considered as the goal pose, moves longer than replan.max_goal_moving_dist in one cycle. (default: 15.0 [ms])"
        },
        {
          "sentence-id": 6,
          "text": "When the goal pose is set again, the planning should be reset."
        },
        {
          "sentence-id": 7,
          "text": "3.Time passes. (default: 1.0 [s])"
        },
        {
          "sentence-id": 8,
          "text": "The optimization is skipped for a while sine the optimization is sometimes heavy."
        },
        {
          "sentence-id": 9,
          "text": "4.The input path changes laterally longer than replan.max_path_shape_around_ego_lat_dist in one cycle. (default: 2.0)"
        }
      ]
    },
    {
      "section-id": 4,
      "title": "Flowchart : getModelPredictiveTrajectory",
      "sentences": [
        {
          "sentence-id": 0,
          "text": "This module makes the trajectory kinematically-feasible and collision-free."
        },
        {
          "sentence-id": 1,
          "text": "We define vehicle pose in the frenet coordinate, and minimize tracking errors by optimization."
        },
        {
          "sentence-id": 2,
          "text": "This optimization considers vehicle kinematics and collision checking with road boundary and obstacles."
        },
        {
          "sentence-id": 3,
          "text": "To decrease the computation cost, the optimization is applied to the shorter trajectory (default: 50 [m]) than the whole trajectory, and concatenate the remained trajectory with the optimized one at last."
        },
        {
          "sentence-id": 4,
          "text": "The trajectory just in front of the ego must not be changed a lot so that the steering wheel will be stable."
        },
        {
          "sentence-id": 5,
          "text": "Therefore, we use the previously generated trajectory in front of the ego."
        },
        {
          "sentence-id": 6,
          "text": "Optimization center on the vehicle, that tries to locate just on the trajectory, can be tuned along side the vehicle vertical axis."
        },
        {
          "sentence-id": 7,
          "text": "This parameter mpt.kinematics.optimization center offset is defined as the signed length from the back-wheel center to the optimization center."
        },
        {
          "sentence-id": 8,
          "text": "Some examples are shown in the following figure, and it is shown that the trajectory of vehicle shape differs according to the optimization center even if the reference trajectory (green one) is the same."
        }
      ]
    },
    {
      "section-id": 5,
      "title": "Flowchart : applyInputVelocity",
      "sentences": [
        {
          "sentence-id": 0,
          "text": "Velocity is assigned in the optimized trajectory from the velocity in the behavior path."
        },
        {
          "sentence-id": 1,
          "text": "The shapes of the optimized trajectory and the path are different, therefore the each nearest trajectory point to the path is searched and the velocity is interpolated with zero-order hold."
        }
      ]
    },
    {
      "section-id": 6,
      "title": "Flowchart : insertZeroVelocityOutsideDrivableArea",
      "sentences": [
        {
          "sentence-id": 0,
          "text": "Optimized trajectory is too short for velocity planning, therefore extend the trajectory by concatenating the optimized trajectory and the behavior path considering drivability."
        },
        {
          "sentence-id": 1,
          "text": "Generated trajectory is checked if it is inside the drivable area or not, and if outside drivable area, output a trajectory inside drivable area with the behavior path or the previously generated trajectory."
        },
        {
          "sentence-id": 2,
          "text": "As described above, the behavior path is separated into two paths: one is for optimization and the other is the remain."
        },
        {
          "sentence-id": 3,
          "text": "The first path becomes optimized trajectory, and the second path just is transformed to a trajectory."
        },
        {
          "sentence-id": 4,
          "text": "Then a trajectory inside the drivable area is calculated as follows."
        },
        {
          "sentence-id": 5,
          "text": "1.If optimized trajectory is inside the drivable area, and the remained trajectory is inside/outside the drivable area, the output trajectory will be just concatenation of those two trajectories."
        },
        {
          "sentence-id": 6,
          "text": "In this case, we do not care if the remained trajectory is inside or outside the drivable area since generally it is outside the drivable area (especially in a narrow road), but we want to pass a trajectory as long as possible to the latter module."
        },
        {
          "sentence-id": 7,
          "text": "2.If optimized trajectory is outside the drivable area, and the remained trajectory is inside/outside the drivable area, and if the previously generated trajectory is memorized, the output trajectory will be the previously generated trajectory, where zero velocity is inserted to the point firstly going outside the drivable area; and if the previously generated trajectory is not memorized, the output trajectory will be a part of trajectory just transformed from the behavior path, where zero velocity is inserted to the point firstly going outside the drivable area."
        },
        {
          "sentence-id": 8,
          "text": "Optimization failure is dealt with the same as if the optimized trajectory is outside the drivable area."
        },
        {
          "sentence-id": 9,
          "text": "The output trajectory is memorized as a previously generated trajectory for the next cycle."
        }
      ]
    },
    {
      "section-id": 7,
      "title": "Flowchart : insertZeroVelocityOutsideDrivableArea : _Rationale_",
      "sentences": [
        {
          "sentence-id": 0,
          "text": "In the current design, since there are some modelling errors, the constraints are considered to be soft constraints."
        },
        {
          "sentence-id": 1,
          "text": "Therefore, we have to make sure that the optimized trajectory is inside the drivable area or not after optimization."
        }
      ]
    },
    {
      "section-id": 8,
      "title": "Limitation",
      "sentences": [
        {
          "sentence-id": 0,
          "text": "1.Computation cost is sometimes high."
        },
        {
          "sentence-id": 1,
          "text": "2.Because of the approximation such as linearization, some narrow roads cannot be run by the planner."
        },
        {
          "sentence-id": 2,
          "text": "3.Roles of planning for behavior_path_planner and path_optimizer are not decided clearly."
        },
        {
          "sentence-id": 3,
          "text": "Both can avoid obstacles."
        }
      ]
    },
    {
      "section-id": 9,
      "title": "Comparison to other methods",
      "sentences": [
        {
          "sentence-id": 0,
          "text": "Trajectory planning problem that satisfies kinematically-feasibility and collision-free has two main characteristics that makes hard to be solved: one is non-convex and the other is high dimension."
        },
        {
          "sentence-id": 1,
          "text": "Based on the characteristics, we investigate pros/cons of the typical planning methods: optimization-based, sampling-based, and learning-based method."
        }
      ]
    },
    {
      "section-id": 10,
      "title": "Comparison to other methods : Optimization-based method",
      "sentences": [
        {
          "sentence-id": 0,
          "text": "pros: comparatively fast against high dimension by leveraging the gradient descent"
        },
        {
          "sentence-id": 1,
          "text": "cons: often converge to the local minima in the non-convex problem"
        }
      ]
    },
    {
      "section-id": 11,
      "title": "Comparison to other methods : Sampling-based method",
      "sentences": [
        {
          "sentence-id": 0,
          "text": "pros: realize global optimization"
        },
        {
          "sentence-id": 1,
          "text": "cons: high computation cost especially in the complex case"
        }
      ]
    },
    {
      "section-id": 12,
      "title": "Comparison to other methods : Learning-based method",
      "sentences": [
        {
          "sentence-id": 0,
          "text": "under research yet"
        },
        {
          "sentence-id": 1,
          "text": "Based on these pros/cons, we chose the optimization-based planner first."
        },
        {
          "sentence-id": 2,
          "text": "Although it has a cons to converge to the local minima, it can get a good solution by the preprocessing to approximate the problem to convex that almost equals to the original non-convex problem."
        }
      ]
    },
    {
      "section-id": 13,
      "title": "How to Tune Parameters : Drivability in narrow roads",
      "sentences": [
        {
          "sentence-id": 0,
          "text": "1.modify mpt.clearance.soft_clearance_from_road"
        },
        {
          "sentence-id": 1,
          "text": "This parameter describes how much margin to make between the trajectory and road boundaries."
        },
        {
          "sentence-id": 2,
          "text": "Due to the model error for optimization, the constraint such as collision-free is not fully met."
        },
        {
          "sentence-id": 3,
          "text": "By making this parameter larger, the is for narrow-road driving may be resolved."
        },
        {
          "sentence-id": 4,
          "text": "2.modify mpt.kinematics.optimization_center_offset"
        },
        {
          "sentence-id": 5,
          "text": "The point on the vehicle, offset forward with this parameter from the base link` tries to follow the reference path."
        },
        {
          "sentence-id": 6,
          "text": "3.change or tune the method to approximate footprints with a set of circles."
        },
        {
          "sentence-id": 7,
          "text": "Tuning means changing the ratio of circle's radius."
        }
      ]
    },
    {
      "section-id": 14,
      "title": "How to Tune Parameters : Computation time",
      "sentences": [
        {
          "sentence-id": 0,
          "text": "under construction"
        }
      ]
    },
    {
      "section-id": 15,
      "title": "How to Tune Parameters : Robustness",
      "sentences": [
        {
          "sentence-id": 0,
          "text": "1.Check if the trajectory before or after MPT is not robust"
        },
        {
          "sentence-id": 1,
          "text": "if the trajectory before MPT is not robust"
        },
        {
          "sentence-id": 2,
          "text": "if the trajectory after MPT is not robust, make mpt.weight.steer_input_weight or mpt.weight.steer_rate_weight larger, which are stability of steering wheel along the trajectory."
        }
      ]
    },
    {
      "section-id": 16,
      "title": "How to Tune Parameters : Other options",
      "sentences": [
        {
          "sentence-id": 0,
          "text": "option.enable_skip_optimization skips MPT optimization."
        },
        {
          "sentence-id": 1,
          "text": "option.enable_calculation_time_info enables showing each calculation time for functions and total calculation time on the terminal."
        },
        {
          "sentence-id": 2,
          "text": "option.enable_outside_drivable_area_stop enables stopping just before the generated trajectory point will be outside the drivable area."
        }
      ]
    }
  ]
}